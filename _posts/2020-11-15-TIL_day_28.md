---
title: "TIL day 28 (Nov 15)"
date: 2020-11-15
categories: wecode TIL python django authentication authorization token posting decorator
toc: true
toc_sticky: true
---


posting.views.py
```python
import json

from django.http    import JsonResponse
from django.views   import View

from user.utils     import login_decorator
from user.models    import Account
from .models        import Post


class PostingView(View):
    @login_decorator
    def post(self,request):
        print(request.body)
        data = json.loads(request.body)
        print(data)
        user = Account.objects.get(id=request.user.id)

        Post(
            author = user, # 객체를 담음 (엄밀하게는 user_id가 담김)
            content = data['content'],
            image_url = data['image_url']
        ).save()
        
        return JsonResponse({'MESSAGE':'CREATED'}, status = 201)

class ReadPostingView(View):
    @login_decorator
    def get(self,request):
        #data = json.loads(request.body)
        posts = Post.objects.all()

        if not posts:
            return JsonResponse({'MESSAGE':'POST_NOT_FOUND'}, status = 404)

        postings = [{
            'post_id' : post.id,
            'post_author' : post.author.id,
            'post_content' : post.content,
            'post_image_url' : post.image_url,
            'post_created' : post.created_at}        for post in posts]
        return JsonResponse({'posts':postings}, status = 200)
```


posting.urls.py
```python
from django.urls    import path

from .views         import PostingView, ReadPostingView

urlpatterns = [
    path('/create', PostingView.as_view()),
    path('/read',   ReadPostingView.as_view())
]
```

posting.models.py
```python
from django.db      import models
from user.models    import Account

class Post(models.Model):
    author      = models.ForeignKey(Account, on_delete=models.CASCADE)
    content     = models.TextField(null=True)
    created_at  = models.DateTimeField(auto_now_add=True)
    image_url   = models.URLField(max_length=500, null=True)

    class Meta:
        db_table: 'posts'


class Comment(models.Model):
    post       = models.ForeignKey(Post, on_delete = models.CASCADE)
    author     = models.ForeignKey(Account, on_delete = models.CASCADE)
    content    = models.TextField(max_length = 240)
    created_at = models.DateTimeField(auto_now_add = True)

    class Meta:
        db_table = 'comments'
```


project.settings.py

```python
"""
Django settings for project_westagram project.

Generated by 'django-admin startproject' using Django 3.1.3.

For more information on this file, see
https://docs.djangoproject.com/en/3.1/topics/settings/

For the full list of settings and their values, see
https://docs.djangoproject.com/en/3.1/ref/settings/
"""

from pathlib import Path
import my_settings
# Build paths inside the project like this: BASE_DIR / 'subdir'.

BASE_DIR = Path(__file__).resolve().parent.parent

# Quick-start development settings - unsuitable for production
# See https://docs.djangoproject.com/en/3.1/howto/deployment/checklist/

# SECURITY WARNING: keep the secret key used in production secret!
SECRET_KEY = my_settings.SECRET_KEY

# SECURITY WARNING: don't run with debug turned on in production!
DEBUG = True

ALLOWED_HOSTS = ['*']

ALGORITHM = my_settings.ALGORITHM


# Application definition

INSTALLED_APPS = [
   # 'django.contrib.admin',
   # 'django.contrib.auth',
    'django.contrib.contenttypes',
    'django.contrib.sessions',
    'django.contrib.messages',
    'django.contrib.staticfiles',
    'corsheaders',
    'user',
    'posting'
]

MIDDLEWARE = [
    'django.middleware.security.SecurityMiddleware',
    'django.contrib.sessions.middleware.SessionMiddleware',
    'django.middleware.common.CommonMiddleware',
   # 'django.middleware.csrf.CsrfViewMiddleware',
   # 'django.contrib.auth.middleware.AuthenticationMiddleware',
    'django.contrib.messages.middleware.MessageMiddleware',
    'django.middleware.clickjacking.XFrameOptionsMiddleware',
    'corsheaders.middleware.CorsMiddleware',
]

ROOT_URLCONF = 'project_westagram.urls'

TEMPLATES = [
    {
        'BACKEND': 'django.template.backends.django.DjangoTemplates',
        'DIRS': [],
        'APP_DIRS': True,
        'OPTIONS': {
            'context_processors': [
                'django.template.context_processors.debug',
                'django.template.context_processors.request',
                'django.contrib.auth.context_processors.auth',
                'django.contrib.messages.context_processors.messages',
            ],
        },
    },
]

WSGI_APPLICATION = 'project_westagram.wsgi.application'


# Database
# https://docs.djangoproject.com/en/3.1/ref/settings/#databases

DATABASES = my_settings.DATABASES

# Password validation
# https://docs.djangoproject.com/en/3.1/ref/settings/#auth-password-validators

AUTH_PASSWORD_VALIDATORS = [
    {
        'NAME': 'django.contrib.auth.password_validation.UserAttributeSimilarityValidator',
    },
    {
        'NAME': 'django.contrib.auth.password_validation.MinimumLengthValidator',
    },
    {
        'NAME': 'django.contrib.auth.password_validation.CommonPasswordValidator',
    },
    {
        'NAME': 'django.contrib.auth.password_validation.NumericPasswordValidator',
    },
]


# Internationalization
# https://docs.djangoproject.com/en/3.1/topics/i18n/

LANGUAGE_CODE = 'ko-kr'

TIME_ZONE = 'Asia/Seoul'

USE_I18N = True

USE_L10N = True

USE_TZ = True


# Static files (CSS, JavaScript, Images)
# https://docs.djangoproject.com/en/3.1/howto/static-files/

STATIC_URL = '/static/'

#REMOVE_APPEND_SLASH_WARNING
APPEND_SLASH = False
##CORS
CORS_ORIGIN_ALLOW_ALL=True
CORS_ALLOW_CREDENTIALS = True

CORS_ALLOW_METHODS = (
    'DELETE',
    'GET',
    'OPTIONS',
    'PATCH',
    'POST',
    'PUT',
)

CORS_ALLOW_HEADERS = (
    'accept',
    'accept-encoding',
    'authorization',
    'content-type',
    'dnt',
    'origin',
    'user-agent',
    'x-csrftoken',
    'x-requested-with',
)
```

project.urls.py

```python
from django.urls import path, include

urlpatterns = [
    path('user', include('user.urls')),
    path('posting', include('posting.urls'))
]
```


user.views.py
```python
import json
import bcrypt
import jwt
import re

from django.views                import View
from django.http                 import JsonResponse, HttpResponse
from django.db.models            import Q

from django.conf                 import settings
from .models                     import Account

class SignUpView(View):
    def post(self, request): #포스트로 받을 시 저장
        data = json.loads(request.body)
        try:        
        #    user = Account(
        #        name         = data['name'],
        #        phone_number = data['phone_number'],
        #        email        = data['email'],
        #        password     = data['password']
        #    )
            email_valid      = re.compile('^[a-zA-Z0-9+-_.]+@[a-zA-Z0-9-]+\.[a-zA-Z0-9-.]+$')
            if not email_valid.match(data['email']):
                return JsonResponse({"MESSAGE" : "EMAIL_ERROR, MUST CONTAIN  '@'  and  '.'"}, status = 400)
            elif len(data['password']) < 8:
                return JsonResponse({"MESSAGE" : "SHORT_PASSWORD, MUST BE MORE THAN 7 DIGITS"}, status = 400)
            elif Account.objects.filter(email = data['email']).exists() or Account.objects.filter(name = data['name']).exists() or Account.objects.filter(phone_number = data['phone_number']).exists() :
                return JsonResponse({"MESSAGE" : "DUPLICATED_INFORMATION"}, status = 401)
            Account.objects.create(
            name         = data['name'],
            phone_number = data['phone_number'],
            email        = data['email'],
            password     = bcrypt.hashpw(data['password'].encode("UTF-8"), bcrypt.gensalt()).decode("UTF-8"))
            return JsonResponse({"MESSAGE" : "SUCCESS"}, status = 201)
        except KeyError:
            return JsonResponse({"MESSAGE" : "KEY_ERROR"}, status = 400)

    def get(self, request): #겟으로 받을시 유저테이블에 있는것 출력
        account_data = Account.objects.values()
        return JsonResponse({'ACCOUNT DATA' : list(account_data)}, status = 200)

class LoginView(View):
    def post(self, request):
        data        = json.loads(request.body)
        user_account = Account.objects.filter(Q(name = data['user_account']) | Q(email = data['user_account']) | Q(phone_number=data['user_account']))
            #if 'name' not in data or 'email' not in data or 'phone_number' not in data:
            #    more_info_error = 'ERROR, MUST CONTAINS NAME,EMAIL,PHONE_NUMBER'
            #    return JsonResponse({'MESSAGE' : more_info_error},   status = 400)
        if 'user_account' not in data or 'password' not in data:
            return JsonResponse({"message" : "KEY_ERROR"}, status = 400)
        if not user_account:
            return JsonResponse({"message" : "INVALID_USER"}, status = 400)
        if bcrypt.checkpw(data['password'].encode('UTF-8'), user_account.values()[0]['password'].encode('UTF-8')):
            token = jwt.encode({'user_id' : user_account.values()[0]['id']}, settings.SECRET_KEY, algorithm=settings.ALGORITHM).decode('UTF-8')
            print(token)
            #header = jwt.decode(token, SECRET_KEY, algorithm = ALGORITHM) #header 뽑아볼려고 쓴것
            #user_object = Account.objects.get(id=header['user_id']) # 그 user id 객체 어서오고
            return JsonResponse({'TOKEN' : token}, status = 200)
        return JsonResponse({"MESSAGE" : "INVALID_USER"}, status = 401)
```

user.models.py
```python
from django.db import models

class Account(models.Model):
    name            = models.CharField(max_length=30)
    phone_number    = models.CharField(max_length=30)
    email           = models.EmailField(max_length=100)
    password        = models.CharField(max_length=200)
    created_at      = models.DateTimeField(auto_now_add=True)
    updated_at      = models.DateTimeField(auto_now=True)

    class Meta:
        db_table    = 'accounts'

```

user.utils.py
```python
import jwt
import json

from django.http import JsonResponse
from django.core.exceptions import ObjectDoesNotExist
from django.conf import settings

from .models import Account

def login_decorator(func):
    def wrapper(self, request, *args, **kwargs):
        try:
            token=request.headers.get('Authorization', None)
            payload=jwt.decode(token, settings.SECRET_KEY, algorithm=settings.ALGORITHM)
            request.user = Account.objects.get(id = payload['user_id'])
            return func(self, request, *args, **kwargs)

        except Account.DoesNotExist:
            return JsonResponse({"message" : "INVALID_USER"}, status=400)
        except jwt.exceptions.DecodeError:
            return JsonResponse({'MESSAGE': 'INVALID TOKEN'}, status=400)
    return wrapper
```

밖에 있는 my_settings.py
```python


# SECURITY WARNING: keep the secret key used in production secret!
SECRET_KEY = 'secret_key'
#SECRET_KEY = '8n%m2r^9^rlsnka#6wqm4v06y36(25hctist8#znv%eya(t$2u'

ALGORITHM = 'HS256'

DATABASES = {
    'default' : {
        'ENGINE': 'django.db.backends.mysql',
        'NAME': 'westagram',
        'USER': 'root',
        'PASSWORD': '11',
        'HOST': 'localhost',
        'PORT': '8000',
    }
}
```